# Secret Rotation Reminder Workflow
# Rappels automatiques pour la rotation des secrets

name: Secret Rotation Reminder

on:
  schedule:
    # Tous les lundis a 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Forcer la verification'
        required: false
        default: 'false'

permissions:
  contents: read
  issues: write

jobs:
  check-rotation:
    name: Check Secret Rotation Status
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check rotation periods
        id: check
        run: |
          # Calculer les dates de rotation recommandees
          cat << 'EOF' > check_rotation.py
          import json
          from datetime import datetime, timedelta

          ROTATION_PERIODS = {
              "JWT_SECRET": 90,
              "ENCRYPTION_KEY": 180,
              "POSTGRES_PASSWORD": 30,
              "REDIS_PASSWORD": 30,
              "SMTP_PASSWORD": 90,
              "OAUTH_SECRETS": 365,
              "CAPTCHA_SECRET_KEY": 180,
              "WG_PRIVATE_KEYS": 365,
          }

          today = datetime.now()
          warnings = []
          info = []

          for secret, period in ROTATION_PERIODS.items():
              if period <= 30:
                  warnings.append(f"- **{secret}**: rotation recommandee tous les {period} jours")
              elif period <= 90:
                  info.append(f"- {secret}: rotation recommandee tous les {period} jours")

          output = {
              "warnings": warnings,
              "info": info,
              "date": today.strftime("%Y-%m-%d")
          }

          print(json.dumps(output))
          EOF

          python check_rotation.py > rotation_status.json
          cat rotation_status.json

      - name: Create rotation reminder issue
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = JSON.parse(fs.readFileSync('rotation_status.json', 'utf8'));

            const body = `## Rappel de rotation des secrets

            **Date**: ${status.date}

            ### Secrets a rotation frequente (attention requise)

            ${status.warnings.join('\n')}

            ### Autres secrets

            ${status.info.join('\n')}

            ---

            ### Actions recommandees

            1. Verifier la date de derniere rotation de chaque secret
            2. Planifier la rotation des secrets expires ou proches de l'expiration
            3. Utiliser le script \`scripts/rotate_secrets.py\` pour generer de nouveaux secrets
            4. Mettre a jour le gestionnaire de secrets (Vault/Infisical/AWS)
            5. Documenter la rotation effectuee

            ### Documentation

            - [Guide de rotation des secrets](docs/AUDIT_SECURITE.md)
            - Script: \`python scripts/rotate_secrets.py --help\`

            ---
            *Ce rappel est genere automatiquement chaque semaine.*
            `;

            // Chercher une issue existante
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'secret-rotation',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Mettre a jour l'issue existante
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // Creer une nouvelle issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Security] Rappel rotation des secrets - ${status.date}`,
                body: body,
                labels: ['secret-rotation', 'security', 'maintenance']
              });
              console.log('Created new rotation reminder issue');
            }

      - name: Summary
        run: |
          echo "## Secret Rotation Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Voir l'issue GitHub pour les details et recommandations." >> $GITHUB_STEP_SUMMARY
