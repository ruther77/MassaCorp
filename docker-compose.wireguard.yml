# ============================================
# MassaCorp Docker Compose - Isolation Complete WireGuard
# ============================================
# Architecture:
#   - WireGuard: Passerelle VPN (seul point d'entree)
#   - API: Accessible uniquement via WireGuard
#   - DB: Isolee, accessible uniquement via reseau interne
# ============================================

services:
  # ==========================================
  # Passerelle VPN WireGuard
  # ==========================================
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: massacorp_wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
      # Configuration serveur
      - SERVERURL=${WG_SERVER_URL:-vpn.massacorp.com}
      - SERVERPORT=${WG_LISTEN_PORT:-51820}
      - INTERNAL_SUBNET=${WG_NETWORK:-10.10.0.0/24}
      - ALLOWEDIPS=${WG_ALLOWED_IPS:-10.10.0.0/24}
      # Peers initiaux (optionnel, geres via API ensuite)
      - PEERS=${WG_INITIAL_PEERS:-}
      - PEERDNS=${WG_DNS:-10.10.0.1}
      - LOG_CONFS=true
    volumes:
      - ./wireguard/config:/config
      - ./wireguard/scripts:/etc/wireguard/scripts:ro
      - /lib/modules:/lib/modules:ro
    ports:
      # SEUL port expose publiquement
      - "51820:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    networks:
      wg_network:
        ipv4_address: 10.10.0.1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wg", "show", "wg0"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Base de donnees PostgreSQL (ISOLEE)
  # ==========================================
  db:
    image: postgres:16-alpine
    container_name: massacorp_db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-MassaCorp}
      POSTGRES_USER: ${POSTGRES_USER:-massa}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-jemmysev}
      # Securite PostgreSQL
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/sql/00_init_flat.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ./db/wireguard/wg_peers.sql:/docker-entrypoint-initdb.d/02_wireguard.sql:ro
    # AUCUN PORT EXPOSE - accessible uniquement via reseau interne
    # ports:
    #   - "5432:5432"  # DESACTIVE pour isolation complete
    networks:
      wg_network:
        ipv4_address: 10.10.0.3
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-massa} -d ${POSTGRES_DB:-MassaCorp}"]
      interval: 5s
      timeout: 5s
      retries: 20
    restart: unless-stopped

  # ==========================================
  # API FastAPI (ISOLEE)
  # ==========================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: massacorp_api
    depends_on:
      db:
        condition: service_healthy
      wireguard:
        condition: service_healthy
    environment:
      - ENV=${ENV:-prod}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Connexion DB via reseau interne
      - DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER:-massa}:${POSTGRES_PASSWORD:-jemmysev}@10.10.0.3:5432/${POSTGRES_DB:-MassaCorp}
      # Configuration WireGuard
      - WG_SERVER_PUBLIC_KEY=${WG_SERVER_PUBLIC_KEY}
      - WG_NETWORK=${WG_NETWORK:-10.10.0.0/24}
    volumes:
      - .:/app:ro
      - ./wireguard/config:/etc/wireguard:ro
    # AUCUN PORT EXPOSE - accessible uniquement via WireGuard
    # ports:
    #   - "8000:8000"  # DESACTIVE pour isolation complete
    expose:
      - "8000"
    networks:
      wg_network:
        ipv4_address: 10.10.0.2
    command: >
      bash -lc "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    restart: unless-stopped

  # ==========================================
  # Synchronisation des Peers WireGuard (Cron)
  # ==========================================
  wg-sync:
    image: postgres:16-alpine
    container_name: massacorp_wg_sync
    depends_on:
      - db
      - wireguard
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-massa}:${POSTGRES_PASSWORD:-jemmysev}@10.10.0.3:5432/${POSTGRES_DB:-MassaCorp}
      - WG_INTERFACE=wg0
    volumes:
      - ./wireguard/scripts:/scripts:ro
      - ./wireguard/config:/config
    networks:
      wg_network:
        ipv4_address: 10.10.0.4
    entrypoint: >
      sh -c "
        apk add --no-cache wireguard-tools bash &&
        while true; do
          /scripts/sync_peers.sh full
          sleep 60
        done
      "
    restart: unless-stopped

  # ==========================================
  # Redis (Optionnel - pour cache/sessions)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: massacorp_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-massacorp_redis_secret}
    volumes:
      - redisdata:/data
    # Aucun port expose
    networks:
      wg_network:
        ipv4_address: 10.10.0.5
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-massacorp_redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

# ==========================================
# Reseaux
# ==========================================
networks:
  wg_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.0.0/24
          gateway: 10.10.0.254

# ==========================================
# Volumes persistants
# ==========================================
volumes:
  pgdata:
    driver: local
  redisdata:
    driver: local
